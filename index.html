<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>倒水游戏关卡编辑器</title>
    <style>
        /* 全局样式 */
        :root {
            --primary-color: #4c9afa;
            --primary-hover: #3a7bc8;
            --success-color: #4CAF50;
            --error-color: #f44336;
            --warning-color: #ff9800;
            --dark-bg: #333;
            --darker-bg: #222;
            --lighter-bg: #444;
            --text-color: #eee;
            --border-color: #555;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* 顶部工具栏 */
        .toolbar {
            display: flex;
            padding: 10px;
            background-color: var(--lighter-bg);
            border-bottom: 1px solid var(--border-color);
        }
        
        /* 按钮样式 */
        button {
            margin: 5px;
            padding: 5px 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover {
            background-color: var(--primary-hover);
        }
        
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        
        #btn-new {
            background-color: #2196F3;
        }
        
        #btn-new:hover {
            background-color: #0b7dda;
        }
        
        #btn-import {
            background-color: var(--warning-color);
        }
        
        #btn-import:hover {
            background-color: #e68a00;
        }
        
        #btn-export {
            background-color: var(--success-color);
        }
        
        #btn-export:hover {
            background-color: #45a049;
        }
        
        #btn-delete {
            background-color: var(--error-color);
        }
        
        #btn-delete:hover {
            background-color: #da190b;
        }
        
        #btn-update-bottles {
            background-color: #9c27b0;
        }
        
        #btn-update-bottles:hover {
            background-color: #7b1fa2;
        }
        
        /* 主要内容区 */
        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* 左侧关卡列表 */
        .levels-panel {
            width: 200px;
            padding: 10px;
            background-color: var(--dark-bg);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }
        
        #level-list {
            margin-top: 10px;
        }
        
        .level-item {
            padding: 5px;
            margin-bottom: 5px;
            background-color: var(--lighter-bg);
            cursor: pointer;
            border-radius: 3px;
        }
        
        .level-item:hover {
            background-color: #555;
        }
        
        .level-item.selected {
            background-color: var(--primary-color);
        }
        
        /* 右侧编辑区 */
        .editor-panel {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }
        
        h2 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        
        .form-row {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        
        .form-row > label {
            width: 120px;
            margin-right: 10px;
        }
        
        /* 输入框样式 */
        input, select {
            background-color: var(--lighter-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 4px;
            border-radius: 3px;
            margin: 2px;
        }
        
        /* 瓶子容器 */
        .bottles-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 10px;
        }
        
        .bottle {
            width: 120px;
            background-color: var(--lighter-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .bottle-label {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .bottle-graphic {
            width: 60px;
            height: 120px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid #888;
            border-radius: 0 0 15px 15px;
            position: relative;
            overflow: hidden;
            margin: 0 auto 10px auto;
        }
        
        .bottle-property {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .bottle-property-label {
            font-size: 12px;
            margin-right: 5px;
        }
        
        .bottle-property select,
        .bottle-property input {
            width: 60px;
            padding: 2px;
            font-size: 12px;
        }
        
        .bottle-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .bottle-actions button {
            padding: 3px 6px;
            font-size: 12px;
            margin: 0;
        }
        
        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
            width: 100%;
            justify-content: center;
        }
        
        .color-option {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .color-option:hover {
            transform: scale(1.2);
        }
        
        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 5px white;
        }
        
        .color-option.empty {
            background-color: transparent !important;
            position: relative;
        }
        
        .color-option.empty::before {
            content: "";
            position: absolute;
            top: 8px;
            left: -2px;
            width: 24px;
            height: 2px;
            background-color: red;
            transform: rotate(45deg);
        }
        
        /* 状态栏 */
        .status-bar {
            padding: 5px 10px;
            background-color: var(--lighter-bg);
            border-top: 1px solid var(--border-color);
            font-size: 12px;
        }
        
        /* 关卡操作按钮组 */
        .level-actions {
            display: flex;
            margin-top: 10px;
            gap: 5px;
        }
        
        #btn-save-level {
            background-color: #8bc34a;
        }
        
        #btn-save-level:hover {
            background-color: #7cb342;
        }
        
        /* 保存指示器 */
        .save-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 5px;
            background-color: var(--success-color);
            color: white;
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        
        .save-indicator.show {
            opacity: 1;
        }
        
        /* 导出指南 */
        .export-guide {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--darker-bg);
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            font-size: 14px;
            color: var(--text-color);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .export-guide h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #ffffff;
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 5px;
        }
        
        .export-guide ol {
            margin: 0;
            padding-left: 20px;
        }
        
        .export-guide li {
            margin-bottom: 8px;
        }
        
        .export-guide code {
            background-color: var(--lighter-bg);
            padding: 2px 5px;
            border-radius: 3px;
            color: #ff9800;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button id="btn-new">新建关卡</button>
        <button id="btn-import">导入CSV</button>
        <button id="btn-export">导出CSV</button>
        <button id="btn-delete" disabled>删除关卡</button>
    </div>
    <div class="content">
        <div class="levels-panel">
            <h2>关卡列表</h2>
            <div id="level-list"></div>
        </div>
        <div class="editor-panel">
            <h2>关卡编辑</h2>
            <div class="form-row">
                <label>关卡ID:</label>
                <input type="number" id="level-id" min="1" value="1">
            </div>
            <div class="form-row">
                <label>目标数量:</label>
                <input type="number" id="level-target" min="1" max="20" value="3">
            </div>
            <div class="form-row">
                <label>时间限制:</label>
                <input type="number" id="level-time" min="0" value="0">
                <span>（0表示无限制）</span>
            </div>
            <div class="form-row">
                <label>关卡消耗:</label>
                <input type="number" id="level-cost" min="0" value="0">
            </div>
            <div class="level-actions">
                <button id="btn-save-level">保存当前关卡</button>
            </div>
            <div class="form-row">
                <label>瓶子数量:</label>
                <input type="number" id="bottle-count" min="1" max="10" value="5">
                <button id="btn-update-bottles">更新数量</button>
                <button id="btn-add-bottle">添加瓶子</button>
            </div>
            <h2>瓶子编辑</h2>
            <div id="bottles-container" class="bottles-container">
                <!-- 瓶子将在这里动态生成 -->
            </div>
            <div class="export-guide">
                <h3>如何使用您编辑的数据</h3>
                <ol>
                    <li>点击"<strong>保存当前关卡</strong>"会自动保存当前关卡到浏览器存储中</li>
                    <li>点击"<strong>导出CSV</strong>"会下载完整的level.csv文件</li>
                    <li>将下载的CSV文件复制到您的游戏目录：<code>assets/resources/data/level.csv</code></li>
                    <li>所有编辑数据会自动保存在浏览器中，关闭后再打开仍然保留</li>
                </ol>
            </div>
        </div>
    </div>
    <div id="status-bar" class="status-bar">准备就绪</div>
    <div id="save-indicator" class="save-indicator">已保存</div>

    <script>
        // 全局变量
        let levelList = [];
        let currentLevel = null;
        let currentLevelIndex = -1;
        let colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ff8800', '#8800ff', '#00ff88'];
        
        // DOM元素引用
        let $btnNew, $btnImport, $btnExport, $btnDelete, $btnUpdateBottles, $btnAddBottle, $btnSaveLevel;
        let $levelList, $bottlesContainer;
        let $levelId, $levelTarget, $levelTime, $levelCost, $bottleCount, $statusBar;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('编辑器初始化中...');
                initDomReferences();
                registerEventListeners();
                console.log('开始加载CSV文件');
                // 首先尝试加载CSV文件
                loadDefaultCSV()
                    .then(success => {
                        if (!success) {
                            console.log('CSV加载失败，尝试从localStorage恢复');
                            // 如果CSV加载失败，尝试从localStorage恢复
                            const savedLevels = localStorage.getItem('pourWaterLevels');
                            if (savedLevels) {
                                try {
                                    levelList = JSON.parse(savedLevels);
                                    if (Array.isArray(levelList) && levelList.length > 0) {
                                        setCurrentLevel(0);
                                        updateLevelList();
                                        updateStatus('已从本地存储加载关卡数据');
                                    } else {
                                        throw new Error('无效的关卡数据');
                                    }
                                } catch (e) {
                                    console.error('加载本地关卡数据失败:', e);
                                    createDefaultLevel();
                                    updateStatus('创建了一个默认关卡');
                                }
                            } else {
                                createDefaultLevel();
                                updateStatus('创建了一个默认关卡');
                            }
                        }
                    });
                
                // 每5秒自动保存一次数据
                setInterval(saveToLocalStorage, 5000);
                
                // 显示提示信息
                setTimeout(function() {
                    showMessage('编辑器已准备就绪，自动保存已启用');
                }, 1000);
            } catch (error) {
                console.error('初始化失败:', error);
                updateStatus('初始化失败: ' + error.message);
            }
        });
        
        // 初始化DOM引用
        function initDomReferences() {
            $btnNew = document.getElementById('btn-new');
            $btnImport = document.getElementById('btn-import');
            $btnExport = document.getElementById('btn-export');
            $btnDelete = document.getElementById('btn-delete');
            $btnUpdateBottles = document.getElementById('btn-update-bottles');
            $btnAddBottle = document.getElementById('btn-add-bottle');
            $btnSaveLevel = document.getElementById('btn-save-level');
            
            $levelList = document.getElementById('level-list');
            $bottlesContainer = document.getElementById('bottles-container');
            
            $levelId = document.getElementById('level-id');
            $levelTarget = document.getElementById('level-target');
            $levelTime = document.getElementById('level-time');
            $levelCost = document.getElementById('level-cost');
            $bottleCount = document.getElementById('bottle-count');
            $statusBar = document.getElementById('status-bar');
        }
        
        // 注册事件监听
        function registerEventListeners() {
            // 按钮点击事件
            $btnNew.addEventListener('click', onClickNew);
            $btnImport.addEventListener('click', onClickImport);
            $btnExport.addEventListener('click', onClickExport);
            $btnDelete.addEventListener('click', onClickDelete);
            $btnUpdateBottles.addEventListener('click', onClickUpdateBottles);
            $btnAddBottle.addEventListener('click', onClickAddBottle);
            $btnSaveLevel.addEventListener('click', onClickSaveLevel);
            
            // 启用删除按钮
            $btnDelete.disabled = false;
            
            // 输入变化事件
            $levelId.addEventListener('change', onLevelPropertyChange);
            $levelTarget.addEventListener('change', onLevelPropertyChange);
            $levelTime.addEventListener('change', onLevelPropertyChange);
            $levelCost.addEventListener('change', onLevelPropertyChange);
            
            // 隐藏文件输入控件，使用按钮触发
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.csv';
            fileInput.style.display = 'none';
            fileInput.addEventListener('change', handleFileSelect);
            document.body.appendChild(fileInput);
            
            // 保存为全局变量以便访问
            window.fileInput = fileInput;
        }
        
        // 导入按钮点击事件
        function onClickImport() {
            window.fileInput.click();
        }
        
        // 处理文件选择
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            updateStatus('正在加载文件...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                
                // 检查是否为单个关卡文件
                if (file.name.startsWith('level_') && file.name.endsWith('.csv')) {
                    // 尝试合并单个关卡
                    if (mergeLevel(content)) {
                        updateStatus(`成功导入关卡文件: ${file.name}`);
                        showMessage(`✅ 成功导入关卡文件：${file.name}`);
                    }
                } else {
                    // 否则作为完整CSV处理
                    processCSVContent(content);
                    updateStatus('成功加载CSV文件: ' + file.name);
                    showMessage(`✅ 成功导入${levelList.length}个关卡，数据已加载！`);
                }
            };
            reader.onerror = function() {
                updateStatus('读取文件失败');
                showMessage('❌ 读取文件失败，请重试！');
            };
            reader.readAsText(file);
            
            // 重置文件输入，允许重新选择同一文件
            event.target.value = '';
        }
        
        // 解析CSV内容
        function processCSVContent(content) {
            if (!content || content.trim() === '') {
                updateStatus('错误：CSV内容为空');
                showMessage('❌ 导入失败：CSV内容为空');
                return;
            }
            
            levelList = [];
            const lines = content.split('\n');
            
            // 检查是否有标题行
            if (lines.length < 2) {
                updateStatus('错误：CSV格式不正确，缺少标题行或数据');
                showMessage('❌ 导入失败：CSV格式不正确，缺少标题行或数据');
                return;
            }
            
            // 解析标题行以确定瓶子数量
            const header = lines[0].trim().split(',');
            if (header.length < 5) { // id,target,time,cost至少需要这些字段
                updateStatus('错误：CSV头部格式不正确');
                showMessage('❌ 导入失败：CSV头部格式不正确');
                return;
            }
            
            // 找到瓶子字段的起始位置和数量
            const bottleStartIndex = 4; // 从第5列开始是瓶子数据 (bottle1)
            const bottleCount = header.length - bottleStartIndex;
            
            // 解析每一行数据
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue; // 跳过空行
                
                const columns = line.split(',');
                if (columns.length < bottleStartIndex + 1) continue; // 至少需要有一个瓶子数据
                
                const level = {
                    id: parseInt(columns[0]) || i,
                    target: parseInt(columns[1]) || 3,
                    time: parseInt(columns[2]) || 0,
                    cost: parseInt(columns[3]) || 0,
                    bottles: []
                };
                
                // 解析每个瓶子数据
                for (let j = 0; j < bottleCount; j++) {
                    if (bottleStartIndex + j >= columns.length) break;
                    
                    const bottleData = columns[bottleStartIndex + j].split(';');
                    if (bottleData.length >= 3) {
                        // 确保瓶子类型至少为1，不允许使用类型0
                        let bottleType = parseInt(bottleData[0]) || 1;
                        if (bottleType === 0) bottleType = 1;
                        
                        level.bottles.push({
                            type: bottleType, // 确保至少为1
                            capacity: parseInt(bottleData[1]) || 4,
                            initialWater: parseInt(bottleData[2]) || 0,
                            targetWater: bottleData.length > 3 ? (parseInt(bottleData[3]) || 0) : 0
                        });
                    }
                }
                
                levelList.push(level);
            }
            
            if (levelList.length === 0) {
                // 如果未成功加载任何关卡，创建默认关卡
                createDefaultLevel();
                updateStatus('未能加载有效关卡，已创建默认关卡');
                showMessage('⚠️ 未能加载有效关卡，已创建默认关卡');
            } else {
                // 加载第一个关卡
                setCurrentLevel(0);
                updateStatus(`成功导入${levelList.length}个关卡`);
                showMessage(`✅ 成功导入${levelList.length}个关卡！`);
            }
            
            // 更新UI
            updateLevelList();
        }
        
        // 初始化瓶子类型选择
        function initBottleTypes() {
            const bottleTypeSelect = document.getElementById('bottle-type');
            bottleTypeSelect.innerHTML = '';
            
            // 移除类型0，只保留1-7的瓶子类型
            for (let i = 1; i <= 7; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `类型 ${i}`;
                bottleTypeSelect.appendChild(option);
            }
        }
        
        // 创建默认关卡
        function createDefaultLevel() {
            const level = {
                id: 1,
                target: 3,
                time: 0,
                cost: 0,
                bottles: []
            };
            
            // 添加4个瓶子，使用类型1而不是0
            for (let i = 0; i < 4; i++) {
                level.bottles.push({ 
                    type: 1, 
                    capacity: 4, 
                    initialWater: 0, 
                    targetWater: 0 
                });
            }
            
            levelList.push(level);
            currentLevelIndex = 0;
            setCurrentLevel(0);
            updateLevelList();
            saveLevelData();
            return level;
        }
        
        // 设置当前关卡
        function setCurrentLevel(index) {
            if (index < 0 || index >= levelList.length) return;
            
            currentLevelIndex = index;
            currentLevel = levelList[index];
            
            // 更新UI显示当前关卡信息
            updateLevelUI();
        }
        
        // 更新关卡列表UI
        function updateLevelList() {
            $levelList.innerHTML = '';
            
            levelList.forEach((level, index) => {
                const li = document.createElement('li');
                li.textContent = `关卡 ${level.id}`;
                li.classList.add('level-item');
                
                if (index === currentLevelIndex) {
                    li.classList.add('selected');
                }
                
                li.addEventListener('click', () => {
                    setCurrentLevel(index);
                    
                    // 移除其他选中状态
                    document.querySelectorAll('.level-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // 添加选中状态
                    li.classList.add('selected');
                });
                
                $levelList.appendChild(li);
            });
        }
        
        // 更新关卡UI
        function updateLevelUI() {
            if (!currentLevel) return;
            
            // 更新关卡属性输入框
            $levelId.value = currentLevel.id;
            $levelTarget.value = currentLevel.target;
            $levelTime.value = currentLevel.time;
            $levelCost.value = currentLevel.cost;
            $bottleCount.value = currentLevel.bottles.length;
            
            // 更新瓶子容器
            updateBottlesUI();
        }
        
        // 更新瓶子UI
        function updateBottlesUI() {
            $bottlesContainer.innerHTML = '';
            
            // 创建瓶子容器
            const bottlesRow = document.createElement('div');
            bottlesRow.className = 'bottles-row';
            bottlesRow.style.display = 'flex';
            bottlesRow.style.flexWrap = 'wrap';
            bottlesRow.style.gap = '20px';
            
            // 添加瓶子
            currentLevel.bottles.forEach((bottle, index) => {
                const bottleElem = document.createElement('div');
                bottleElem.className = 'bottle';
                
                // 瓶子标签
                const bottleLabel = document.createElement('div');
                bottleLabel.className = 'bottle-label';
                bottleLabel.textContent = `瓶子 ${index + 1}`;
                bottleElem.appendChild(bottleLabel);
                
                // 瓶子图形
                const bottleGraphic = document.createElement('div');
                bottleGraphic.className = 'bottle-graphic';
                
                // 根据类型设置瓶子颜色 - 移除空瓶，只保留1-7的类型
                const bottleTypes = ['未使用', '红色', '蓝色', '绿色', '黄色', '紫色', '青色', '橙色'];
                const bottleColors = ['#888', '#ff0000', '#0000ff', '#00ff00', '#ffff00', '#ff00ff', '#00ffff', '#ff8800'];
                
                // 确保类型是1-7范围
                const typeIndex = Math.max(1, Math.min(7, bottle.type));
                bottleGraphic.style.borderColor = bottleColors[typeIndex];
                
                // 显示初始水量
                let fillHeight = Math.min(100, (bottle.initialWater / bottle.capacity) * 100);
                if (isNaN(fillHeight) || !isFinite(fillHeight)) fillHeight = 0;
                
                const fillElem = document.createElement('div');
                fillElem.style.position = 'absolute';
                fillElem.style.bottom = '0';
                fillElem.style.left = '0';
                fillElem.style.width = '100%';
                fillElem.style.height = `${fillHeight}%`;
                fillElem.style.backgroundColor = bottleColors[typeIndex];
                fillElem.style.opacity = '0.7';
                
                bottleGraphic.appendChild(fillElem);
                bottleElem.appendChild(bottleGraphic);
                
                // 瓶子类型
                const typeProperty = document.createElement('div');
                typeProperty.className = 'bottle-property';
                
                const typeLabel = document.createElement('span');
                typeLabel.className = 'bottle-property-label';
                typeLabel.textContent = '类型:';
                
                const typeSelect = document.createElement('select');
                typeSelect.className = 'bottle-type-select';
                
                // 添加1-7的类型选项，不要类型0
                for (let i = 1; i <= 7; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}:${bottleTypes[i]}`;
                    typeSelect.appendChild(option);
                }
                
                typeSelect.value = typeIndex;
                typeSelect.addEventListener('change', (e) => {
                    bottle.type = parseInt(e.target.value);
                    updateBottlesUI();
                    saveLevelData();
                });
                
                typeProperty.appendChild(typeLabel);
                typeProperty.appendChild(typeSelect);
                bottleElem.appendChild(typeProperty);
                
                // 初始水量
                const initialProperty = document.createElement('div');
                initialProperty.className = 'bottle-property';
                
                const initialLabel = document.createElement('span');
                initialLabel.className = 'bottle-property-label';
                initialLabel.textContent = '初始水量:';
                
                const initialInput = document.createElement('input');
                initialInput.type = 'number';
                initialInput.min = '0';
                initialInput.max = bottle.capacity;
                initialInput.value = bottle.initialWater;
                initialInput.addEventListener('change', (e) => {
                    const value = parseInt(e.target.value) || 0;
                    bottle.initialWater = Math.max(0, Math.min(bottle.capacity, value));
                    e.target.value = bottle.initialWater;
                    updateBottlesUI();
                });
                
                initialProperty.appendChild(initialLabel);
                initialProperty.appendChild(initialInput);
                bottleElem.appendChild(initialProperty);
                
                // 目标水量
                const targetProperty = document.createElement('div');
                targetProperty.className = 'bottle-property';
                
                const targetLabel = document.createElement('span');
                targetLabel.className = 'bottle-property-label';
                targetLabel.textContent = '目标水量:';
                
                const targetInput = document.createElement('input');
                targetInput.type = 'number';
                targetInput.min = '0';
                targetInput.max = bottle.capacity;
                targetInput.value = bottle.targetWater;
                targetInput.addEventListener('change', (e) => {
                    const value = parseInt(e.target.value) || 0;
                    bottle.targetWater = Math.max(0, Math.min(bottle.capacity, value));
                    e.target.value = bottle.targetWater;
                    updateBottlesUI();
                });
                
                targetProperty.appendChild(targetLabel);
                targetProperty.appendChild(targetInput);
                bottleElem.appendChild(targetProperty);
                
                // 瓶子操作
                const bottleActions = document.createElement('div');
                bottleActions.className = 'bottle-actions';
                
                // 删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '删除';
                deleteBtn.style.backgroundColor = '#f44336';
                deleteBtn.addEventListener('click', () => {
                    deleteBottle(index);
                });
                bottleActions.appendChild(deleteBtn);
                
                bottleElem.appendChild(bottleActions);
                bottlesRow.appendChild(bottleElem);
            });
            
            $bottlesContainer.appendChild(bottlesRow);
        }
        
        // 删除瓶子
        function deleteBottle(bottleIndex) {
            currentLevel.bottles.splice(bottleIndex, 1);
            $bottleCount.value = currentLevel.bottles.length;
            updateBottlesUI();
            updateStatus(`已删除瓶子 ${bottleIndex + 1}`);
        }
        
        // 点击新建按钮
        function onClickNew() {
            const newLevel = {
                id: levelList.length > 0 ? Math.max(...levelList.map(l => l.id)) + 1 : 1,
                target: 3,
                time: 60,
                cost: 3,
                bottles: [
                    { type: 1, capacity: 4, initialWater: 4, targetWater: 4 },
                    { type: 2, capacity: 4, initialWater: 4, targetWater: 4 },
                    { type: 3, capacity: 4, initialWater: 0, targetWater: 0 },
                    { type: 4, capacity: 4, initialWater: 0, targetWater: 0 },
                    { type: 5, capacity: 4, initialWater: 0, targetWater: 0 }
                ]
            };
            
            levelList.push(newLevel);
            setCurrentLevel(levelList.length - 1);
            updateLevelList();
            updateStatus('已创建新关卡');
        }
        
        // 点击删除按钮
        function onClickDelete() {
            if (levelList.length <= 1) {
                updateStatus('无法删除唯一的关卡');
                return;
            }
            
            if (currentLevelIndex >= 0 && currentLevelIndex < levelList.length) {
                levelList.splice(currentLevelIndex, 1);
                setCurrentLevel(Math.min(currentLevelIndex, levelList.length - 1));
                updateLevelList();
                updateStatus('已删除当前关卡');
            }
        }
        
        // 点击更新瓶子按钮
        function onClickUpdateBottles() {
            if (!currentLevel) return;
            
            const newCount = parseInt($bottleCount.value) || 0;
            if (newCount < 1) {
                updateStatus('瓶子数量必须大于0');
                $bottleCount.value = currentLevel.bottles.length;
                return;
            }
            
            const currentCount = currentLevel.bottles.length;
            
            if (newCount === currentCount) {
                return; // 没有变化
            }
            
            if (newCount > currentCount) {
                // 添加新瓶子
                for (let i = currentCount; i < newCount; i++) {
                    currentLevel.bottles.push({ 
                        type: 0, 
                        capacity: 4, 
                        initialWater: 0, 
                        targetWater: 0 
                    });
                }
            } else {
                // 移除多余的瓶子
                currentLevel.bottles = currentLevel.bottles.slice(0, newCount);
            }
            
            updateBottlesUI();
            updateStatus(`已更新瓶子数量到 ${newCount}`);
        }
        
        // 点击添加瓶子按钮
        function onClickAddBottle() {
            if (!currentLevel) return;
            
            currentLevel.bottles.push({ 
                type: 0, 
                capacity: 4, 
                initialWater: 0, 
                targetWater: 0 
            });
            $bottleCount.value = currentLevel.bottles.length;
            updateBottlesUI();
            updateStatus('已添加一个新瓶子');
        }
        
        // 点击导出按钮
        function onClickExport() {
            if (levelList.length === 0) {
                updateStatus('没有可导出的关卡');
                return;
            }
            
            try {
                // 创建CSV内容
                const csvContent = generateCSVContent();
                
                // 创建并下载文件
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'level.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 释放URL对象
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                updateStatus('已导出关卡数据到CSV文件 (保存在下载文件夹)');
                
                // 添加提示信息
                showMessage('提示：在GitHub Pages环境中，无法自动保存到仓库。请手动将导出的CSV文件提交到您的GitHub仓库。');
            } catch (error) {
                console.error('导出失败:', error);
                updateStatus('导出失败: ' + error.message);
            }
        }
        
        // 生成CSV内容
        function generateCSVContent() {
            if (levelList.length === 0) return '';
            
            // 找到最大瓶子数量
            let maxBottleCount = 0;
            levelList.forEach(level => {
                maxBottleCount = Math.max(maxBottleCount, level.bottles.length);
            });
            
            // 生成标题行
            let csv = 'id,target,time,cost';
            for (let i = 1; i <= maxBottleCount; i++) {
                csv += `,bottle${i}`;
            }
            csv += '\n';
            
            // 生成每个关卡的数据行
            levelList.forEach(level => {
                csv += `${level.id},${level.target},${level.time},${level.cost}`;
                
                // 添加瓶子数据
                for (let i = 0; i < maxBottleCount; i++) {
                    csv += ',';
                    if (i < level.bottles.length) {
                        const bottle = level.bottles[i];
                        // 确保瓶子类型至少为1
                        const bottleType = bottle.type === 0 ? 1 : bottle.type;
                        csv += `${bottleType};${bottle.capacity};${bottle.initialWater}`;
                        if (bottle.targetWater > 0) {
                            csv += `;${bottle.targetWater}`;
                        }
                    }
                }
                
                csv += '\n';
            });
            
            return csv;
        }
        
        // 显示一个临时消息
        function showMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.style.position = 'fixed';
            messageBox.style.top = '20px';
            messageBox.style.left = '50%';
            messageBox.style.transform = 'translateX(-50%)';
            messageBox.style.padding = '12px 20px';
            messageBox.style.backgroundColor = '#333';
            messageBox.style.color = '#fff';
            messageBox.style.border = '1px solid #4c9afa';
            messageBox.style.borderRadius = '4px';
            messageBox.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.3)';
            messageBox.style.zIndex = '1000';
            messageBox.style.fontWeight = 'bold';
            messageBox.style.fontSize = '16px';
            messageBox.textContent = message;
            
            document.body.appendChild(messageBox);
            
            // 添加淡入效果
            messageBox.style.opacity = '0';
            messageBox.style.transition = 'opacity 0.3s';
            setTimeout(() => {
                messageBox.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                messageBox.style.opacity = '0';
                messageBox.style.transition = 'opacity 0.5s';
                setTimeout(() => document.body.removeChild(messageBox), 500);
            }, 5000);
        }
        
        // 保存到localStorage
        function saveToLocalStorage() {
            if (levelList && levelList.length > 0) {
                try {
                    localStorage.setItem('pourWaterLevels', JSON.stringify(levelList));
                    console.log('自动保存完成');
                    
                    // 显示保存指示器
                    const saveIndicator = document.getElementById('save-indicator');
                    saveIndicator.classList.add('show');
                    setTimeout(() => {
                        saveIndicator.classList.remove('show');
                    }, 2000);
                } catch (e) {
                    console.error('自动保存失败:', e);
                }
            }
        }
        
        // 更新状态栏
        function updateStatus(message) {
            $statusBar.textContent = message;
            console.log(message);
        }
        
        // 加载默认CSV文件
        async function loadDefaultCSV() {
            try {
                // 尝试多个可能的路径
                const possiblePaths = ['./level.csv', 'level.csv', './data/level.csv', '../level.csv'];
                let loaded = false;
                
                for (const csvPath of possiblePaths) {
                    try {
                        console.log('尝试加载CSV文件:', csvPath);
                        updateStatus('尝试加载CSV文件: ' + csvPath);
                        
                        const response = await fetch(csvPath);
                        
                        if (!response.ok) {
                            console.warn(`路径 ${csvPath} 加载失败: ${response.statusText}`);
                            continue;
                        }
                        
                        const content = await response.text();
                        if (!content || content.trim() === '') {
                            console.warn(`路径 ${csvPath} 文件为空`);
                            continue;
                        }
                        
                        console.log('找到CSV文件:', csvPath, '内容长度:', content.length);
                        processCSVContent(content);
                        updateStatus(`已成功从 ${csvPath} 加载CSV文件`);
                        loaded = true;
                        break;
                    } catch (err) {
                        console.warn(`尝试路径 ${csvPath} 失败:`, err);
                    }
                }
                
                return loaded;
            } catch (error) {
                console.warn('加载默认CSV文件失败:', error);
                updateStatus('加载默认CSV失败: ' + error.message);
                return false;
            }
        }
        
        // 关卡属性变更
        function onLevelPropertyChange() {
            if (!currentLevel) return;
            
            currentLevel.id = parseInt($levelId.value) || 0;
            currentLevel.target = parseInt($levelTarget.value) || 1;
            currentLevel.time = parseInt($levelTime.value) || 60;
            currentLevel.cost = parseInt($levelCost.value) || 3;
            
            // 更新关卡列表中显示的ID
            updateLevelList();
        }
        
        // 保存单个关卡
        function onClickSaveLevel() {
            if (!currentLevel) {
                updateStatus('没有选中关卡，无法保存');
                return;
            }
            
            try {
                // 确保属性更新
                onLevelPropertyChange();
                
                // 保存到localStorage
                saveToLocalStorage();
                
                // 显示保存成功提示
                updateStatus(`已保存关卡 ${currentLevel.id}`);
                showMessage(`关卡 ${currentLevel.id} 已保存`);
            } catch (error) {
                console.error('保存关卡失败:', error);
                updateStatus('保存关卡失败: ' + error.message);
            }
        }
        
        // 合并单个关卡数据
        function mergeLevel(csvContent) {
            try {
                // 从CSV中提取关卡数据
                const lines = csvContent.split('\n');
                if (lines.length < 2) {
                    throw new Error('CSV格式不正确');
                }
                
                // 解析单个关卡数据
                const parts = lines[1].split(',');
                if (parts.length < 5) {
                    throw new Error('关卡数据不完整');
                }
                
                const levelId = parseInt(parts[0]) || 0;
                
                // 检查是否已存在相同ID的关卡
                const existingIndex = levelList.findIndex(level => level.id === levelId);
                
                // 使用processCSVContent处理数据，然后找到对应ID的关卡
                const oldList = [...levelList]; // 备份原始列表
                processCSVContent(csvContent);
                
                // 找到新导入的关卡
                const importedLevel = levelList.find(level => level.id === levelId);
                
                if (!importedLevel) {
                    // 如果未找到导入的关卡，恢复原始列表
                    levelList = oldList;
                    throw new Error('导入关卡失败');
                }
                
                if (existingIndex >= 0) {
                    // 如果存在相同ID的关卡，替换它
                    levelList[existingIndex] = importedLevel;
                    setCurrentLevel(existingIndex);
                    updateStatus(`已更新关卡 ${levelId}`);
                } else {
                    // 否则添加为新关卡
                    oldList.push(importedLevel);
                    levelList = oldList;
                    setCurrentLevel(levelList.length - 1);
                    updateStatus(`已添加关卡 ${levelId}`);
                }
                
                updateLevelList();
                return true;
            } catch (error) {
                console.error('合并关卡失败:', error);
                updateStatus('合并关卡失败: ' + error.message);
                return false;
            }
        }
    </script>
</body>
</html> 